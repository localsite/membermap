<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listings Display</title>
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .header .info {
            color: #666;
            font-size: 0.9rem;
        }

        .controls-container {
            margin-bottom: 24px;
        }

        .search-container {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .show-selector {
            min-width: 200px;
        }

        .show-select {
            width: 100%;
            padding: 12px 16px;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .show-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .search-wrapper {
            flex: 1;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .search-box {
            position: relative;
            flex: 1;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            width: 20px;
            height: 20px;
        }

        .search-fields-control {
            position: relative;
            min-width: 150px;
        }

        .search-fields-btn {
            padding: 12px 16px;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-fields-btn:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .search-fields-btn.active {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .search-popup {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 280px;
            max-width: 400px;
        }

        .search-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #e5e5e5;
        }

        .search-popup-title {
            font-weight: 600;
            color: #1a1a1a;
        }

        .search-popup-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-popup-close:hover {
            color: #333;
        }

        .search-popup-actions {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5e5;
        }

        .popup-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .popup-btn:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .search-fields-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 8px 0;
        }

        .search-field-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-field-item:hover {
            background: #f8f9fa;
        }

        .search-field-checkbox {
            margin: 0;
        }

        .search-field-label {
            flex: 1;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .search-results {
            font-size: 0.9rem;
            color: #666;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .pagination-info {
            font-size: 0.9rem;
            color: #666;
            margin: 0 16px;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .page-numbers {
            display: flex;
            gap: 4px;
        }

        .loading {
            text-align: center;
            padding: 48px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            text-align: center;
            padding: 24px;
        }

        .error-box {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 16px;
            border-radius: 8px;
            display: inline-block;
        }

        .error-title {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .listings-grid {
            display: grid;
            gap: 24px;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        }

        .listing-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e5e5;
            padding: 24px;
            transition: box-shadow 0.2s, transform 0.2s;
        }

        .listing-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .listing-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .listing-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
        }

        .listing-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: #4a4a4a;
            margin: 0;
        }

        .listing-category {
            display: inline-block;
            padding: 4px 12px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #1d4ed8;
            background: #dbeafe;
            border-radius: 16px;
            width: fit-content;
        }

        .listing-description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .address-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .address-main {
            color: #4a4a4a;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .address-details {
            color: #666;
            font-size: 0.9rem;
        }

        .contact-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .contact-item {
            color: #4a4a4a;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .contact-item a {
            color: inherit;
            text-decoration: none;
            transition: color 0.2s;
        }

        .contact-item a:hover {
            color: #007bff;
        }

        .population-item {
            color: #4a4a4a;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .additional-details {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e5e5;
        }

        .details-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: #666;
            background: none;
            border: none;
            padding: 0;
            width: 100%;
            justify-content: flex-start;
        }

        .details-toggle:hover {
            color: #007bff;
        }

        .toggle-arrow {
            transition: transform 0.2s;
            font-size: 0.7rem;
        }

        .toggle-arrow.expanded {
            transform: rotate(90deg);
        }

        .details-content {
            margin-top: 8px;
            display: none;
        }

        .details-content.expanded {
            display: block;
        }

        .details-grid {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-row {
            display: flex;
            font-size: 0.85rem;
            gap: 8px;
        }

        .detail-key {
            font-weight: 500;
            color: #666;
            min-width: 0;
            flex-shrink: 0;
        }

        .detail-value {
            color: #4a4a4a;
            word-break: break-word;
            flex: 1;
        }

        .no-results {
            text-align: center;
            padding: 48px;
        }

        .no-results-text {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 12px;
        }

        .clear-search {
            color: #007bff;
            text-decoration: underline;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }

        .clear-search:hover {
            color: #0056b3;
        }

        .empty-state {
            text-align: center;
            padding: 48px;
        }

        .empty-text {
            color: #666;
            font-size: 1.1rem;
        }

        .break-all {
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="app">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading listings...</p>
            </div>
        </div>
    </div>

    <script>
        class ListingsDisplay {
            constructor() {
                this.listings = [];
                this.filteredListings = [];
                this.searchTerm = '';
                this.config = null;
                this.loading = true;
                this.error = null;
                this.showConfigs = {};
                this.currentShow = 'cities';
                this.currentPage = 1;
                this.itemsPerPage = 200;
                this.searchFields = new Set();
                this.availableFields = new Set();
                this.searchPopupOpen = false;
                this.dataLoaded = false;
                
                this.init();
            }

            async init() {
                try {
                    this.showLoadingState("Loading Dataset Choices");
                    await this.loadShowConfigs();
                    
                    this.showLoadingState("Loading listings...");
                    await this.loadShowData();
                    
                    this.render();
                    this.setupEventListeners();
                } catch (err) {
                    console.error('Initialization error:', err);
                    this.error = err.message;
                    this.loading = false;
                    this.render();
                }
            }

            showLoadingState(message) {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>${message}</p>
                    </div>
                `;
            }

            async loadShowConfigs() {
                try {
                    // Try to load adjacent show.json file first
                    try {
                        const response = await fetch('show.json');
                        if (response.ok) {
                            this.showConfigs = await response.json();
                            console.log('Show configs loaded from show.json:', this.showConfigs);
                            return;
                        }
                    } catch (error) {
                        console.log('Could not load show.json, using fallback config');
                    }

                    // Fallback to embedded show.json configuration
                    this.showConfigs = {
                        "cities": {
                            "shortTitle": "Team Locations",
                            "listTitle": "Team Locations",
                            "dataTitle": "Team Locations",
                            "datatype": "csv",
                            "dataset": "/membermap/cities.csv",
                            "markerType": "google",
                            "nameColumn": "city",
                            "search": {
                                "In City": "City",
                                "In County Name": "County"
                            },
                            "datastates": ["GA"],
                            "mapInfo": "Cities and Counties in Georgia"
                        },
                        "recyclers": {
                            "listTitle": "B2B Recyclers",
                            "dataTitle": "B2B Recyclers",
                            "googleCSV": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRBRXb005Plt3mmmJunBMk6IejMu-VAJOPdlHWXUpyecTAF-SK4OpfSjPHNMN_KAePShbNsiOo2hZzt/pub?gid=1924677788&single=true&output=csv",
                            "googleCategories": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRBRXb005Plt3mmmJunBMk6IejMu-VAJOPdlHWXUpyecTAF-SK4OpfSjPHNMN_KAePShbNsiOo2hZzt/pub?gid=381237740&single=true&output=csv",
                            "nameColumn": "organization name",
                            "titleColumn": "organization name",
                            "searchFields": "organization name",
                            "addressColumn": "address",
                            "valueColumn": "category",
                            "valueColumnLabel": "Category",
                            "catColumn": "Category",
                            "subcatColumn": "Materials Accepted",
                            "itemsColumn": "Materials Accepted",
                            "color": "#E31C79",
                            "markerType": "google",
                            "search": {
                                "In Main Category": "Category",
                                "In Materials Accepted": "Materials Accepted",
                                "In Location Name": "organization name",
                                "In Address": "address",
                                "In County Name": "county",
                                "In Website URL": "website"
                            },
                            "datastates": ["GA"],
                            "mapInfo": "Add <a href='https://map.georgia.org/recycling/'>B2B&nbsp;Recycler Listings</a> or post comments to submit additions to our <a href='https://docs.google.com/spreadsheets/d/1YmfBPEFpfmaKmxcnxijPU8-esVkhaVBE1wLZqPNOKtY/edit?usp=sharing' target='georgia_recyclers_sheet'>Google&nbsp;Sheet</a>."
                        }
                    };
                    console.log('Using fallback show configs:', this.showConfigs);
                } catch (error) {
                    console.error('Error loading show configurations:', error);
                    throw error;
                }
            }

            async loadShowData() {
                try {
                    this.loading = true;
                    this.dataLoaded = false;
                    
                    const showConfig = this.showConfigs[this.currentShow];
                    if (!showConfig) {
                        throw new Error(`Could not find show configuration for: ${this.currentShow}`);
                    }
                    
                    this.config = showConfig;
                    console.log('Loading data for config:', showConfig);
                    
                    const data = await this.loadDataFromConfig(showConfig);
                    this.listings = data;
                    this.filteredListings = data;
                    this.currentPage = 1;
                    
                    this.initializeSearchFields();
                    this.dataLoaded = true;
                    
                    console.log('Data loaded:', data.length, 'items');
                    
                } catch (err) {
                    console.error('Error loading show data:', err);
                    this.error = err.message;
                } finally {
                    this.loading = false;
                }
            }

            async loadDataFromConfig(config) {
                try {
                    console.log('Loading data from config:', config);
                    
                    // For demo purposes, create mock data based on the config
                    if (config.googleCSV) {
                        console.log('Attempting to load from googleCSV:', config.googleCSV);
                        return await this.loadGoogleCSV(config.googleCSV);
                    } else if (config.dataset) {
                        console.log('Attempting to load from dataset:', config.dataset);
                        return await this.loadCSVData(config.dataset);
                    } else {
                        // Create mock data based on the current show
                        return this.createMockData(config);
                    }
                } catch (error) {
                    console.error('Error loading data from config:', error);
                    // Fall back to mock data
                    return this.createMockData(config);
                }
            }

            createMockData(config) {
                console.log('Creating mock data for:', this.currentShow);
                
                if (this.currentShow === 'cities') {
                    // Create more mock data to test pagination
                    const cities = [];
                    const baseData = [
                        { city: "Atlanta", County: "Fulton", state: "Georgia", population: "498715", phone: "4045463000", website: "atlantaga.gov", description: "Capital city of Georgia" },
                        { city: "Savannah", County: "Chatham", state: "Georgia", population: "147780", phone: "9126515000", website: "savannahga.gov", description: "Historic coastal city" },
                        { city: "Augusta", County: "Richmond", state: "Georgia", population: "202081", phone: "7067904000", website: "augustaga.gov", description: "Home of the Masters Tournament" },
                        { city: "Columbus", County: "Muscogee", state: "Georgia", population: "194058", phone: "7065962000", website: "columbusga.gov", description: "Historic river city" },
                        { city: "Macon", County: "Bibb", state: "Georgia", population: "153095", phone: "4785512000", website: "maconbibb.us", description: "Heart of Georgia" }
                    ];
                    
                    // Duplicate to create 250+ entries for pagination testing
                    for (let i = 0; i < 50; i++) {
                        baseData.forEach((cityData, index) => {
                            cities.push({
                                ...cityData,
                                city: `${cityData.city} ${i + 1}`,
                                City: `${cityData.city} ${i + 1}`,
                                phone: cityData.phone.replace(/(\d{3})(\d{3})(\d{4})/, `$1$2${(index + i).toString().padStart(4, '0')}`)
                            });
                        });
                    }
                    
                    return cities;
                } else if (this.currentShow === 'recyclers') {
                    return [
                        {
                            "organization name": "Atlanta Recycling Center",
                            "Category": "Paper",
                            "Materials Accepted": "Cardboard, Office Paper",
                            address: "123 Recycling Way, Atlanta, GA",
                            county: "Fulton",
                            website: "atlantarecycling.com"
                        },
                        {
                            "organization name": "Savannah Metal Recovery",
                            "Category": "Metal",
                            "Materials Accepted": "Aluminum, Steel, Copper",
                            address: "456 Metal St, Savannah, GA", 
                            county: "Chatham",
                            website: "savannahmetal.com"
                        }
                    ];
                } else if (this.currentShow === 'landfills') {
                    return [
                        {
                            Name: "Peach County Landfill",
                            County: "Peach",
                            latitude: "32.5",
                            longitude: "-83.8"
                        },
                        {
                            Name: "Gwinnett County Landfill", 
                            County: "Gwinnett",
                            latitude: "33.9",
                            longitude: "-84.1"
                        }
                    ];
                }
                
                return [];
            }

            async loadGoogleCSV(url) {
                try {
                    console.log('Fetching CSV from:', url);
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Failed to load CSV: ${response.status} ${response.statusText}`);
                    }
                    const csvText = await response.text();
                    console.log('CSV loaded, length:', csvText.length);
                    return this.parseCSV(csvText);
                } catch (error) {
                    console.error('Error loading Google CSV:', error);
                    throw error;
                }
            }

            async loadCSVData(url) {
                try {
                    console.log('Fetching CSV from:', url);
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Failed to load CSV: ${response.status} ${response.statusText}`);
                    }
                    const csvText = await response.text();
                    return this.parseCSV(csvText);
                } catch (error) {
                    console.error('Error loading CSV data:', error);
                    throw error;
                }
            }

            parseCSV(csvText) {
                try {
                    console.log('Parsing CSV...');
                    const lines = csvText.trim().split('\n');
                    if (lines.length < 2) {
                        console.warn('CSV has insufficient data');
                        return [];
                    }
                    
                    // Parse headers - handle quoted fields
                    const headerLine = lines[0];
                    const headers = this.parseCSVLine(headerLine);
                    console.log('CSV headers:', headers);
                    
                    const data = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = this.parseCSVLine(lines[i]);
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index] || '';
                            });
                            data.push(row);
                        }
                    }
                    
                    console.log('Parsed CSV data:', data.length, 'rows');
                    return data;
                } catch (error) {
                    console.error('Error parsing CSV:', error);
                    throw error;
                }
            }

            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current.trim());
                return result;
            }

            initializeSearchFields() {
                this.availableFields.clear();
                if (this.listings.length > 0) {
                    Object.keys(this.listings[0]).forEach(key => {
                        this.availableFields.add(key);
                    });
                }
                
                // Start with no fields selected - show all results initially
                this.searchFields.clear();
                
                console.log('Available fields:', Array.from(this.availableFields));
                console.log('Search fields (initially empty):', Array.from(this.searchFields));
            }

            getRecognizedFields(listing) {
                if (!this.config) return {};
                
                const recognized = {};
                
                // Name field
                if (this.config.nameColumn && listing[this.config.nameColumn]) {
                    recognized.name = listing[this.config.nameColumn];
                }
                
                // Title field
                if (this.config.titleColumn && listing[this.config.titleColumn] && this.config.titleColumn !== this.config.nameColumn) {
                    recognized.title = listing[this.config.titleColumn];
                }
                
                // Address field
                if (this.config.addressColumn && listing[this.config.addressColumn]) {
                    recognized.address = listing[this.config.addressColumn];
                }
                
                // Value/Category field
                if (this.config.valueColumn && listing[this.config.valueColumn]) {
                    recognized.category = listing[this.config.valueColumn];
                }
                
                // Common location fields
                ['city', 'City', 'CITY'].forEach(field => {
                    if (listing[field] && !recognized.city) {
                        recognized.city = listing[field];
                    }
                });
                
                ['county', 'County', 'COUNTY'].forEach(field => {
                    if (listing[field] && !recognized.county) {
                        recognized.county = listing[field];
                    }
                });
                
                ['state', 'State', 'STATE'].forEach(field => {
                    if (listing[field] && !recognized.state) {
                        recognized.state = listing[field];
                    }
                });
                
                // Contact fields
                ['phone', 'Phone', 'PHONE', 'telephone'].forEach(field => {
                    if (listing[field] && !recognized.phone) {
                        recognized.phone = listing[field];
                    }
                });
                
                ['email', 'Email', 'EMAIL'].forEach(field => {
                    if (listing[field] && !recognized.email) {
                        recognized.email = listing[field];
                    }
                });
                
                ['website', 'Website', 'WEBSITE', 'url', 'URL'].forEach(field => {
                    if (listing[field] && !recognized.website) {
                        recognized.website = listing[field];
                    }
                });
                
                // Description field
                ['description', 'Description', 'DESCRIPTION', 'details'].forEach(field => {
                    if (listing[field] && !recognized.description) {
                        recognized.description = listing[field];
                    }
                });
                
                // Population field
                ['population', 'Population', 'POPULATION', 'pop'].forEach(field => {
                    if (listing[field] && !recognized.population) {
                        recognized.population = listing[field];
                    }
                });
                
                return recognized;
            }

            getUnrecognizedFields(listing) {
                const recognizedKeys = new Set([
                    this.config?.nameColumn,
                    this.config?.titleColumn,
                    this.config?.addressColumn,
                    this.config?.valueColumn,
                    'city', 'City', 'CITY',
                    'county', 'County', 'COUNTY',
                    'state', 'State', 'STATE',
                    'zip', 'Zip', 'ZIP', 'zipcode', 'postal_code',
                    'population', 'Population', 'POPULATION', 'pop',
                    'phone', 'Phone', 'PHONE', 'telephone',
                    'email', 'Email', 'EMAIL',
                    'website', 'Website', 'WEBSITE', 'url', 'URL',
                    'description', 'Description', 'DESCRIPTION', 'details'
                ]);
                
                const unrecognized = {};
                Object.keys(listing).forEach(key => {
                    if (!recognizedKeys.has(key) && listing[key] && listing[key].toString().trim()) {
                        unrecognized[key] = listing[key];
                    }
                });
                
                return unrecognized;
            }

            formatFieldName(fieldName) {
                return fieldName
                    .replace(/[_-]/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase());
            }

            formatFieldValue(value, fieldType = 'text') {
                if (!value) return '';
                
                const strValue = value.toString();
                
                // Format phone numbers
                if (fieldType === 'phone' || /^\+?[\d\s\-\(\)]+$/.test(strValue)) {
                    return strValue.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
                }
                
                // Format population numbers
                if (fieldType === 'population' || (fieldType === 'text' && /^\d+$/.test(strValue))) {
                    const num = parseInt(strValue);
                    if (!isNaN(num) && num > 1000) {
                        return num.toLocaleString();
                    }
                }
                
                return strValue;
            }

            filterListings() {
                if (!this.searchTerm.trim()) {
                    this.filteredListings = this.listings;
                } else {
                    // If no search fields are selected, search all fields
                    const fieldsToSearch = this.searchFields.size > 0 ? 
                        Array.from(this.searchFields) : 
                        Array.from(this.availableFields);
                    
                    this.filteredListings = this.listings.filter(listing => {
                        return fieldsToSearch.some(field => {
                            const value = listing[field];
                            return value && value.toString().toLowerCase().includes(this.searchTerm.toLowerCase());
                        });
                    });
                }
                this.currentPage = 1;
                this.render();
            }

            getSearchFieldsSummary() {
                if (this.searchFields.size === 0) return 'Select Filters';
                if (this.searchFields.size === this.availableFields.size) return 'All fields';
                
                // Get display names from config if available
                const displayNames = [];
                if (this.config && this.config.search) {
                    Object.entries(this.config.search).forEach(([displayName, fieldName]) => {
                        if (this.searchFields.has(fieldName)) {
                            displayNames.push(displayName);
                        }
                    });
                }
                
                // If we have display names, use those
                if (displayNames.length > 0) {
                    if (displayNames.length <= 2) {
                        return displayNames.join(', ');
                    } else {
                        return `${displayNames.slice(0, 2).join(', ')}, +${displayNames.length - 2} more`;
                    }
                }
                
                // Otherwise use field names
                const fieldNames = Array.from(this.searchFields).slice(0, 2);
                let summary = fieldNames.join(', ');
                
                if (this.searchFields.size > 2) {
                    summary += `, +${this.searchFields.size - 2} more`;
                }
                
                if (summary.length > 40) {
                    summary = summary.substring(0, 37) + '...';
                }
                
                return summary;
            }

            toggleSearchField(field) {
                if (this.searchFields.has(field)) {
                    this.searchFields.delete(field);
                } else {
                    this.searchFields.add(field);
                }
                this.filterListings();
            }

            useConfigSearchFields() {
                this.searchFields.clear();
                if (this.config && this.config.search) {
                    Object.values(this.config.search).forEach(field => {
                        this.searchFields.add(field);
                    });
                } else {
                    this.availableFields.forEach(field => {
                        this.searchFields.add(field);
                    });
                }
                this.filterListings();
            }

            toggleSearchPopup() {
                this.searchPopupOpen = !this.searchPopupOpen;
                this.render();
            }

            closeSearchPopup() {
                this.searchPopupOpen = false;
                this.render();
            }

            async changeShow(showKey) {
                this.currentShow = showKey;
                this.searchPopupOpen = false;
                await this.loadShowData();
                this.render();
            }

            setupEventListeners() {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.searchTerm = e.target.value;
                        this.filterListings();
                    });
                }

                const showSelect = document.getElementById('showSelect');
                if (showSelect) {
                    showSelect.addEventListener('change', (e) => {
                        this.changeShow(e.target.value);
                    });
                }

                const clearSearch = document.getElementById('clearSearch');
                if (clearSearch) {
                    clearSearch.addEventListener('click', () => {
                        this.searchTerm = '';
                        const searchInput = document.getElementById('searchInput');
                        if (searchInput) searchInput.value = '';
                        this.filterListings();
                    });
                }

                const searchFieldsBtn = document.getElementById('searchFieldsBtn');
                if (searchFieldsBtn) {
                    searchFieldsBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleSearchPopup();
                    });
                }

                // Close popup when clicking outside
                document.addEventListener('click', (e) => {
                    if (this.searchPopupOpen && !e.target.closest('.search-fields-control')) {
                        this.closeSearchPopup();
                    }
                });

                // Handle details toggle and pagination
                document.addEventListener('click', (e) => {
                    // Handle pagination
                    if (e.target.classList.contains('pagination-btn') && !e.target.disabled) {
                        const page = parseInt(e.target.dataset.page);
                        if (!isNaN(page)) {
                            this.changePage(page);
                        }
                        return;
                    }

                    // Handle details toggle - check for both the button and arrow
                    if (e.target.classList.contains('details-toggle') || 
                        e.target.classList.contains('toggle-arrow') ||
                        e.target.closest('.details-toggle')) {
                        
                        e.preventDefault();
                        e.stopPropagation();
                        
                        let toggle = e.target;
                        if (e.target.classList.contains('toggle-arrow')) {
                            toggle = e.target.parentElement;
                        } else if (!e.target.classList.contains('details-toggle')) {
                            toggle = e.target.closest('.details-toggle');
                        }
                        
                        if (toggle) {
                            const content = toggle.nextElementSibling;
                            const arrow = toggle.querySelector('.toggle-arrow');
                            
                            if (content && arrow) {
                                const isExpanded = content.classList.contains('expanded');
                                
                                if (isExpanded) {
                                    content.classList.remove('expanded');
                                    arrow.classList.remove('expanded');
                                } else {
                                    content.classList.add('expanded');
                                    arrow.classList.add('expanded');
                                }
                            }
                        }
                        return;
                    }
                });
            }

            changePage(page) {
                this.currentPage = page;
                this.render();
                // Scroll to top of listings
                const listingsGrid = document.querySelector('.listings-grid');
                if (listingsGrid) {
                    listingsGrid.scrollIntoView({ behavior: 'smooth' });
                }
            }

            getTotalPages() {
                return Math.ceil(this.filteredListings.length / this.itemsPerPage);
            }

            getCurrentPageListings() {
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                return this.filteredListings.slice(startIndex, endIndex);
            }

            renderPagination() {
                // Only show pagination if data is loaded and there are multiple pages
                if (!this.dataLoaded || this.filteredListings.length === 0) return '';
                
                const totalPages = this.getTotalPages();
                if (totalPages <= 1) return '';

                const currentPage = this.currentPage;
                const maxVisiblePages = 5;
                
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }

                const pages = [];
                for (let i = startPage; i <= endPage; i++) {
                    pages.push(i);
                }

                return `
                    <div class="pagination-container">
                        <button class="pagination-btn" data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>
                            Previous
                        </button>
                        
                        <div class="page-numbers">
                            ${startPage > 1 ? `
                                <button class="pagination-btn" data-page="1">1</button>
                                ${startPage > 2 ? '<span>...</span>' : ''}
                            ` : ''}
                            
                            ${pages.map(page => `
                                <button class="pagination-btn ${page === currentPage ? 'active' : ''}" data-page="${page}">
                                    ${page}
                                </button>
                            `).join('')}
                            
                            ${endPage < totalPages ? `
                                ${endPage < totalPages - 1 ? '<span>...</span>' : ''}
                                <button class="pagination-btn" data-page="${totalPages}">${totalPages}</button>
                            ` : ''}
                        </div>
                        
                        <button class="pagination-btn" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'disabled' : ''}>
                            Next
                        </button>
                        
                        <div class="pagination-info">
                            Page ${currentPage} of ${totalPages}
                        </div>
                    </div>
                `;
            }

            render() {
                const app = document.getElementById('app');
                
                if (this.loading) {
                    this.showLoadingState("Loading listings...");
                    return;
                }

                if (this.error) {
                    app.innerHTML = `
                        <div class="error">
                            <div class="error-box">
                                <div class="error-title">Error loading data:</div>
                                <div>${this.error}</div>
                            </div>
                        </div>
                    `;
                    return;
                }

                if (!this.showConfigs || Object.keys(this.showConfigs).length === 0) {
                    this.showLoadingState("Loading Dataset Choices");
                    return;
                }

                app.innerHTML = `
                    <!-- Header -->
                    <div class="header">
                        <h1>${this.config?.listTitle || 'Listings'}</h1>
                        ${this.config?.mapInfo ? `<div class="info">${this.config.mapInfo}</div>` : ''}
                    </div>

                    <!-- Controls -->
                    <div class="controls-container">
                        <div class="search-container">
                            <div class="show-selector">
                                <select id="showSelect" class="show-select">
                                    ${Object.keys(this.showConfigs).map(key => 
                                        `<option value="${key}" ${key === this.currentShow ? 'selected' : ''}>${this.showConfigs[key].listTitle || key}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="search-wrapper">
                                <div class="search-box">
                                    <input
                                        type="text"
                                        id="searchInput"
                                        placeholder="Search listings..."
                                        value="${this.searchTerm}"
                                        class="search-input"
                                    />
                                    <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                                <div class="search-fields-control">
                                    <button id="searchFieldsBtn" class="search-fields-btn ${this.searchPopupOpen ? 'active' : ''}">
                                        ${this.getSearchFieldsSummary()}
                                    </button>
                                    ${this.searchPopupOpen ? this.renderSearchPopup() : ''}
                                </div>
                            </div>
                        </div>
                        <div class="search-results">
                            Showing ${this.getCurrentPageListings().length} of ${this.filteredListings.length} listings
                            ${this.filteredListings.length !== this.listings.length ? ` (${this.listings.length} total)` : ''}
                        </div>
                    </div>

                    <!-- Pagination -->
                    ${this.renderPagination()}

                    <!-- Listings Grid -->
                    <div class="listings-grid">
                        ${this.renderListings()}
                    </div>

                    ${this.renderNoResults()}
                    ${this.renderEmptyState()}
                `;

                setTimeout(() => this.setupEventListeners(), 0);
            }

            renderSearchPopup() {
                const configFields = this.config?.search ? Object.entries(this.config.search) : [];
                
                return `
                    <div class="search-popup">
                        <div class="search-popup-header">
                            <div class="search-popup-title">Search Fields</div>
                            <button class="search-popup-close" onclick="event.stopPropagation(); window.listingsApp.closeSearchPopup();">
                                ×
                            </button>
                        </div>
                        ${configFields.length > 0 ? `
                            <div class="search-popup-actions">
                                <button class="popup-btn" onclick="event.stopPropagation(); window.listingsApp.useConfigSearchFields();">
                                    Use Config Fields
                                </button>
                            </div>
                        ` : ''}
                        <div class="search-fields-list">
                            ${configFields.length > 0 ? 
                                configFields.map(([displayName, fieldName]) => `
                                    <div class="search-field-item" onclick="event.stopPropagation(); window.listingsApp.toggleSearchField('${fieldName}');">
                                        <input 
                                            type="checkbox" 
                                            class="search-field-checkbox"
                                            ${this.searchFields.has(fieldName) ? 'checked' : ''}
                                            onclick="event.stopPropagation(); window.listingsApp.toggleSearchField('${fieldName}');"
                                        />
                                        <label class="search-field-label">${displayName}</label>
                                    </div>
                                `).join('') :
                                Array.from(this.availableFields).map(field => `
                                    <div class="search-field-item" onclick="event.stopPropagation(); window.listingsApp.toggleSearchField('${field}');">
                                        <input 
                                            type="checkbox" 
                                            class="search-field-checkbox"
                                            ${this.searchFields.has(field) ? 'checked' : ''}
                                            onclick="event.stopPropagation(); window.listingsApp.toggleSearchField('${field}');"
                                        />
                                        <label class="search-field-label">${field}</label>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                `;
            }

            renderListings() {
                // Use getCurrentPageListings() to limit results per page
                const currentPageListings = this.getCurrentPageListings();
                
                return currentPageListings.map((listing, index) => {
                    const recognized = this.getRecognizedFields(listing);
                    const unrecognized = this.getUnrecognizedFields(listing);
                    
                    return `
                        <div class="listing-card">
                            <div class="listing-content">
                                ${recognized.name ? `<h3 class="listing-name">${recognized.name}</h3>` : ''}
                                ${recognized.title && recognized.title !== recognized.name ? `<h4 class="listing-title">${recognized.title}</h4>` : ''}
                                
                                ${recognized.category ? `<span class="listing-category">${recognized.category}</span>` : ''}
                                
                                ${recognized.description ? `<p class="listing-description">${recognized.description}</p>` : ''}
                                
                                ${this.renderAddressSection(recognized)}
                                ${this.renderContactSection(recognized)}
                                ${this.renderPopulationSection(recognized)}
                            </div>

                            ${Object.keys(unrecognized).length > 0 ? this.renderAdditionalDetails(unrecognized) : ''}
                        </div>
                    `;
                }).join('');
            }

            renderAddressSection(recognized) {
                const hasAddress = recognized.address || recognized.city || recognized.state || recognized.zip || recognized.county;
                if (!hasAddress) return '';

                return `
                    <div class="address-section">
                        ${recognized.address ? `
                            <div class="address-main">
                                📍 ${recognized.address}
                            </div>
                        ` : ''}
                        
                        ${(recognized.city || recognized.state || recognized.zip) ? `
                            <div class="address-details">
                                ${[recognized.city, recognized.state, recognized.zip].filter(Boolean).join(', ')}
                            </div>
                        ` : ''}
                        
                        ${recognized.county ? `
                            <div class="address-details">
                                ${recognized.county} County
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            renderContactSection(recognized) {
                const hasContact = recognized.phone || recognized.email || recognized.website;
                if (!hasContact) return '';

                return `
                    <div class="contact-section">
                        ${recognized.phone ? `
                            <div class="contact-item">
                                📞 <a href="tel:${recognized.phone}">
                                    ${this.formatFieldValue(recognized.phone, 'phone')}
                                </a>
                            </div>
                        ` : ''}
                        
                        ${recognized.email ? `
                            <div class="contact-item">
                                ✉️ <a href="mailto:${recognized.email}">
                                    ${recognized.email}
                                </a>
                            </div>
                        ` : ''}
                        
                        ${recognized.website ? `
                            <div class="contact-item">
                                🌐 <a 
                                    href="${recognized.website.startsWith('http') ? recognized.website : `https://${recognized.website}`}"
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    class="break-all"
                                >
                                    ${recognized.website}
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            renderPopulationSection(recognized) {
                if (!recognized.population) return '';

                return `
                    <div class="population-item">
                        👥 Population: ${this.formatFieldValue(recognized.population, 'population')}
                    </div>
                `;
            }

            renderAdditionalDetails(unrecognized) {
                return `
                    <div class="additional-details">
                        <button class="details-toggle">
                            <span class="toggle-arrow">▶</span>
                            Additional Details (${Object.keys(unrecognized).length})
                        </button>
                        <div class="details-content">
                            <div class="details-grid">
                                ${Object.entries(unrecognized).map(([key, value]) => `
                                    <div class="detail-row">
                                        <span class="detail-key">${this.formatFieldName(key)}:</span>
                                        <span class="detail-value">${this.formatFieldValue(value)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderNoResults() {
                if (this.filteredListings.length > 0 || this.listings.length === 0) return '';
                
                return `
                    <div class="no-results">
                        <p class="no-results-text">No listings match your search criteria.</p>
                        <button id="clearSearch" class="clear-search">
                            Clear search to show all listings
                        </button>
                    </div>
                `;
            }

            renderEmptyState() {
                if (this.listings.length > 0) return '';
                
                return `
                    <div class="empty-state">
                        <p class="empty-text">No listings available.</p>
                    </div>
                `;
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.listingsApp) {
                window.listingsApp = new ListingsDisplay();
            }
        });
    </script>
</body>
</html>